version: 1.0

description: "Simple show user info workflows"

input:
  - username
  - channel

vars:
  - account_info: null

output:
  - account_info: <% ctx().account_info %>

tasks:

  task1:
    action: chatops.post_message
    input:
      channel: <% ctx().channel %>
      message: "Searching for '<% ctx().username %>' account details..."
      extra:
        mattermost:
          pretext: "Okay, let me do it for you. :smile:"

  task2:
    action: freeipa.action_show_userinfo user_id=<% ctx().username %>
    next: 
      - when: <% succeeded() %>
        publish: account_info=<% result() %>
        do: task3

      - when: <% failed() %>
        publish: account_info=<% result() %>
        do: task4

  task3:
    action: chatops.post_message
    input:
      channel: <% ctx().channel %>
      message: |

        ```
        Account Current Status     : <% ctx().account_info.result['status']%>
        User Name                  : <% ctx().account_info.result['username']%>
        Failed Password Attempted  : <% ctx().account_info.result['failed_password_attempted']%>
        Last Failed Attempted      : <% ctx().account_info.result['last_failed_attempted']%>
        Password Expired Date      : <% ctx().account_info.result['password_expired_date']%>
        Password Valid Days        : <% ctx().account_info.result['password_valid_days']%>
        ```
        Max failure is <% ctx().account_info.result['max_password_failure']%> times. You have <% ctx().account_info.result['chances_left']%> chances left.
      
      extra:
        mattermost:
          pretext: "Hello, @<% ctx().username%>. Here you go for your account details."
          actions:
            - id: "update"
              name: "Change Password"
              integration:
                url: "http://10.13.18.140/api/v1/webhooks/sample?st2-api-key=MzhhNzg4YmNkZjE3OGI1ZTRhNWM0MzYyNjFjMzY2ZWNmZDRlNWI4YjZlYmJjZjM2NGFiOWE1NmQxN2NhYzBlNw"
                context:
                  selected_option: "change_password"

    next:
      - when: <% succeeded() %>
        publish:
          - account_info: <% ctx("account_info") %>, <% result() %>

  task4:
    action: chatops.post_message
    input:
      channel: <% ctx().channel %>
      message: |
        User name '<% ctx().username %>' not found. Please type in the correct user name.
        Thank you. :smile:
      extra: 
        mattermost:
          pretext: "Hello, @<% ctx().username%>. There's something went wrong."
